---
import {
  db,
  eq,
  Blog,
  BlogsToCountries,
  BlogsToLanguages,
  Country,
  Language,
} from 'astro:db';

import { groupBy, uniqueBy } from '../lib/collection';
import { joinList } from '../lib/intl';

export type Props = { collegeId: string };

const { collegeId } = Astro.props;

const rows = await db
  .select()
  .from(Blog)
  .where(eq(Blog.collegeId, collegeId))
  .innerJoin(BlogsToCountries, eq(BlogsToCountries.blogId, Blog.id))
  .innerJoin(Country, eq(BlogsToCountries.countryId, Country.code))
  .innerJoin(BlogsToLanguages, eq(BlogsToLanguages.blogId, Blog.id))
  .innerJoin(Language, eq(BlogsToLanguages.languageId, Language.code));

const groupedRows = groupBy(rows, (row) => row.Blog.id!);

const blogs = Object.values(groupedRows).map((group) => {
  const blog = group[0]?.Blog;
  const countries = uniqueBy(group, (row) => row.Country.code!).map(
    (row) => row.Country.name,
  );
  const languages = uniqueBy(group, (row) => row.Language.code!).map(
    (row) => row.Language.name,
  );
  return { ...blog, countries, languages };
});

const blogsByYear = Object.entries(
  groupBy(blogs, (blog) => blog.year as number),
).sort(
  ([aYear], [bYear]) =>
    (bYear as unknown as number) - (aYear as unknown as number),
);
---

<ul role="list">
  {
    blogsByYear.map(([year, blogs]) => (
      <li data-year={year}>
        <h3 class="year">{year}</h3>
        <ul role="list">
          {blogs.map((blog) => (
            <li class="blog" data-blog={blog.id}>
              {/* prettier-ignore */}
              <a href={blog.url} target="_blank" class="first-name" data-name>{blog.firstName}</a>{' '}
              <span data-countries>{joinList(blog.countries)}</span>
              {' â€“ '}
              <span data-languages>{joinList(blog.languages)}</span>
            </li>
          ))}
        </ul>
      </li>
    ))
  }
</ul>

<style>
  ul {
    list-style-type: none;
    padding: 0;
  }

  .year {
    font-size: var(--font-size-l);
    font-weight: var(--font-weight-regular);
    line-height: var(--line-height-m);
    margin-top: var(--spacing-m);
    margin-bottom: var(--spacing-xxs);
  }

  .blog {
    line-height: var(--line-height-l);
  }

  .first-name {
    color: var(--color-primary);
    font-weight: var(--font-weight-bold);
    text-underline-offset: 0.25em;
    text-decoration-color: var(--color-border);
    margin-right: 0.25em;
  }

  .first-name:hover,
  .first-name:focus {
    text-decoration-color: var(--color-primary);
    text-decoration-thickness: 0.125em;
  }

  /* Hide empty year groups */
  [data-year]:not(:has(.blog:not([hidden]))) {
    display: none;
  }
</style>
